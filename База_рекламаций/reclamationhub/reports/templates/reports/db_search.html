<!-- reports/templates/reports/db_search.html -->
<!-- –®–∞–±–ª–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è "–ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π" -->

{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'reports:analytics' %}">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a></li>
                    <li class="breadcrumb-item active">{{ page_title }}</li>
                </ol>
            </nav>

            <h3 class="text-muted">{{ description }}</h3>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5>üîç –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <!-- –ì–æ–¥ –ø–æ–∏—Å–∫–∞ -->
                        <div class="mb-3">
                            <label for="{{ form.year.id_for_label }}" class="form-label fw-bold">
                                {{ form.year.label }}
                            </label>
                            {{ form.year }}
                            {% if form.year.errors %}
                                <div class="text-danger">{{ form.year.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- –ù–æ–º–µ—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π -->
                        <div class="mb-3">
                            <label for="{{ form.engine_numbers.id_for_label }}" class="form-label fw-bold">
                                {{ form.engine_numbers.label }}
                            </label>
                            {{ form.engine_numbers }}
                            {% if form.engine_numbers.help_text %}
                                <div class="form-text">{{ form.engine_numbers.help_text }}</div>
                            {% endif %}
                            {% if form.engine_numbers.errors %}
                                <div class="text-danger">{{ form.engine_numbers.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- –ù–æ–º–µ—Ä–∞ –∞–∫—Ç–æ–≤ -->
                        <div class="mb-3">
                            <label for="{{ form.act_numbers.id_for_label }}" class="form-label fw-bold">
                                {{ form.act_numbers.label }}
                            </label>
                            {{ form.act_numbers }}
                            {% if form.act_numbers.errors %}
                                <div class="text-danger">{{ form.act_numbers.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞ -->
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" name="quick_search" class="btn btn-primary">
                                üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫
                            </button>
                            <button type="submit" name="detailed_search" class="btn btn-success">
                                üìÑ –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –°–ø—Ä–∞–≤–∫–∞ –ø–æ –ø–æ–∏—Å–∫—É -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5>‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞</h5>
                </div>
                <div class="card-body">
                    <h6>–ù–æ–º–µ—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π:</h6>
                    <p class="small">–ï—Å–ª–∏ –≤ –Ω–æ–º–µ—Ä–µ –¥–≤–∏–≥–∞—Ç–µ–ª—è –µ—Å—Ç—å –±—É–∫–≤—ã, –≤–≤–æ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é - —Å –ê–ù–ì–õ–ò–ô–°–ö–ò–ú–ò –±—É–∫–≤–∞–º–∏.</p>

                    <h6>–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫:</h6>
                    <p class="small">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö/–Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ —Å ID –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>

                    <h6>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç:</h6>
                    <p class="small">–°–æ–∑–¥–∞–µ—Ç TXT —Ñ–∞–π–ª —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è—Ö –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π.</p>

                    <h6>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:</h6>
                    <p class="small">–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞ –≤ –ø–∞–ø–∫–µ.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    {% if messages %}
    <div class="row">
        <div class="col-12">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ -->
    {% if search_results %}
    <div class="row">
        <div class="col-12">
            <div class="card" id="search-results-card" data-scroll-to>
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —Å—Ç–∏–ª–µ alert-success –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="alert alert-success mb-0">
                    <h5 class="mb-1">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h5>
                    {% if search_results.engine_numbers %}
                        <small>–î–≤–∏–≥–∞—Ç–µ–ª–∏: {{ search_results.engine_numbers }}</small><br>
                    {% endif %}
                    {% if search_results.act_numbers %}
                        <small>–ê–∫—Ç—ã: {{ search_results.act_numbers }}</small>
                    {% endif %}
                </div>

                <div class="card-body">
                    {% if search_results.results %}
                        <div class="row">
                            {% for result in search_results.results %}
                                <div class="col-md-6 mb-2">
                                    {% if result.found == False %}
                                        <!-- –ù–µ –Ω–∞–π–¥–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å -->
                                        <div class="alert alert-warning py-2 mb-1">
                                            {{ result.message }}
                                        </div>
                                    {% else %}
                                        <!-- –ù–∞–π–¥–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å -->
                                        <div class="alert alert-success py-2 mb-1">
                                            {% if result.type == 'engine' %}–î–≤–∏–≥–∞—Ç–µ–ª—å{% else %}–ê–∫—Ç{% endif %}
                                            {{ result.found_value }} | —Å—Ç—Ä–æ–∫–∞ {{ result.record_id }} | {{ result.product_info }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ -->
                        <div class="mt-3">
                            <p class="text-muted">–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ.</p>
                        </div>
                    {% else %}
                        <p class="text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Ç–æ–≤–æ–º –æ—Ç—á–µ—Ç–µ -->
    {% if download_info %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-success" id="report-ready-card" data-scroll-to>
                <div class="card-header bg-success text-white">
                    <h5>‚úÖ –û—Ç—á–µ—Ç –≥–æ—Ç–æ–≤</h5>
                </div>
                <div class="card-body">
                    <p><strong>{{ download_info.message }}</strong></p>
                    <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: <strong>{{ download_info.records_count }}</strong></p>

                    <div class="d-flex gap-2 mt-3">
                        <a href="{% url 'reports:download_search_report' %}" target="_blank" class="btn btn-success">
                            üíæ –û—Ç–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç
                        </a>
                        <button class="btn btn-secondary" onclick="this.closest('.card').style.display='none'">
                            ‚ùå –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<script>
/**
 * –°–ö–†–ò–ü–¢ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –î–ê–ù–ù–´–ú–ò –ü–û–ò–°–ö–ê
 * –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
 * 1. –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ –∫–Ω–æ–ø–∫–µ (–±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤)
 * 2. –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–æ–∏—Å–∫–∞
 * 3. –ü–µ—Ä–µ—Ö–≤–∞—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ–± –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö
 */

function clearForm() {
    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ñ–æ—Ä–º—ã –ø–æ –∫–Ω–æ–ø–∫–µ "–û—á–∏—Å—Ç–∏—Ç—å" - –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É —á–µ—Ä–µ–∑ GET –ø–∞—Ä–∞–º–µ—Ç—Ä clear=1
    window.location.href = '{% url "reports:db_search" %}?clear=1';
}

function scrollToElement(elementId, delay = 100) {
    // –§—É–Ω–∫—Ü–∏—è –ø–ª–∞–≤–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç—É —Å data-scroll-to –∞—Ç—Ä–∏–±—É—Ç–æ–º
    // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –∏—Ö –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(function() {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
            element.setAttribute('tabindex', '-1');
            element.focus();
        }
    }, delay);
}

function clearSessionAndRedirect(url) {
    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π URL
    // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–û–ö" –≤ –¥–∏–∞–ª–æ–≥–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    fetch('{% url "reports:db_search" %}?clear=1')
        .then(() => {
            window.location.href = url;
        })
        .catch(() => {
            // –ï—Å–ª–∏ –æ—á–∏—Å—Ç–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ - –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ —Å—Å—ã–ª–∫–µ
            window.location.href = url;
        });
}

document.addEventListener('DOMContentLoaded', function() {
    // === –ê–í–¢–û–ü–†–û–ö–†–£–¢–ö–ê –ö –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú ===
    // –ò—â–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º data-scroll-to –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∏–º
    const elementsToScroll = document.querySelectorAll('[data-scroll-to]');
    elementsToScroll.forEach(function(element) {
        scrollToElement(element.id);
    });

    // === –ü–ï–†–ï–•–í–ê–¢ –í–ù–ï–®–ù–ò–• –°–°–´–õ–û–ö ===
    // –†–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –æ—Ç—á–µ—Ç
    {% if search_results or download_info %}
    document.addEventListener('click', function(event) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª –ø–æ —Å—Å—ã–ª–∫–µ (–∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—É –≤–Ω—É—Ç—Ä–∏ —Å—Å—ã–ª–∫–∏)
        const link = event.target.closest('a');
        if (!link) return; // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å—Å—ã–ª–∫–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL-—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏)
        const currentAppUrls = [
            '{% url "reports:db_search" %}',           // –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∏—Å–∫–∞
            '{% url "reports:download_search_report" %}' // –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç—á–µ—Ç–∞
        ];

        const linkUrl = link.getAttribute('href');

        // –ò–ì–ù–û–†–ò–†–£–ï–ú —Å—Å—ã–ª–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å:
        if (!linkUrl ||                    // –ù–µ—Ç href
            linkUrl.startsWith('#') ||     // –Ø–∫–æ—Ä–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (#section)
            linkUrl.startsWith('javascript:')) return; // JavaScript —Å—Å—ã–ª–∫–∏

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Å—ã–ª–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π (–≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞)
        let isInternalLink = false;
        currentAppUrls.forEach(function(url) {
            if (linkUrl.includes(url)) {
                isInternalLink = true;
            }
        });

        // –ù–ï –ü–ï–†–ï–•–í–ê–¢–´–í–ê–ï–ú:
        // - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ—Å—Ç–∞–µ–º—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–∏—Å–∫–∞)
        // - –°—Å—ã–ª–∫–∏ —Å target="_blank" (–æ—Ç—á–µ—Ç—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ)
        if (isInternalLink || link.target === '_blank') return;

        // === –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–ï–†–ï–•–í–ê–¢–ê ===
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
        event.preventDefault();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        if (confirm('–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Å—Ç–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ. –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?')) {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–û–ö" - –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º
            clearSessionAndRedirect(linkUrl);
        } else {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–û—Ç–º–µ–Ω–∞" - –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏
            window.location.href = linkUrl;
        }
    });
    {% endif %}

    // –í–ê–ñ–ù–û: –ï—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–∞ (search_results –∏–ª–∏ download_info),
    // —Ç–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç —Å—Å—ã–ª–æ–∫ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–≤–æ–±–æ–¥–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –ø–æ —Å–∞–π—Ç—É
});
</script>
{% endblock %}