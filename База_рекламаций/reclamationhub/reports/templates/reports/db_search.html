<!-- reports/templates/reports/db_search.html -->
<!-- –®–∞–±–ª–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è "–ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π" -->

{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'reports:analytics' %}">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a></li>
                    <li class="breadcrumb-item active">{{ page_title }}</li>
                </ol>
            </nav>

            <h3 class="text-muted">{{ description }}</h3>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5>üîç –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <!-- –ì–æ–¥ –ø–æ–∏—Å–∫–∞ -->
                        <div class="mb-3">
                            <label for="{{ form.year.id_for_label }}" class="form-label fw-bold">
                                {{ form.year.label }}
                            </label>
                            {{ form.year }}
                            {% if form.year.errors %}
                                <div class="text-danger">{{ form.year.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- –ù–æ–º–µ—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π -->
                        <div class="mb-3">
                            <label for="{{ form.engine_numbers.id_for_label }}" class="form-label fw-bold">
                                {{ form.engine_numbers.label }}
                            </label>
                            {{ form.engine_numbers }}
                            {% if form.engine_numbers.help_text %}
                                <div class="form-text">{{ form.engine_numbers.help_text }}</div>
                            {% endif %}
                            {% if form.engine_numbers.errors %}
                                <div class="text-danger">{{ form.engine_numbers.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- –ù–æ–º–µ—Ä–∞ –∞–∫—Ç–æ–≤ -->
                        <div class="mb-3">
                            <label for="{{ form.act_numbers.id_for_label }}" class="form-label fw-bold">
                                {{ form.act_numbers.label }}
                            </label>
                            {{ form.act_numbers }}
                            {% if form.act_numbers.errors %}
                                <div class="text-danger">{{ form.act_numbers.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞ -->
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" name="quick_search" class="btn btn-primary">
                                üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫
                            </button>
                            <button type="submit" name="detailed_search" class="btn btn-success">
                                üìÑ –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –°–ø—Ä–∞–≤–∫–∞ –ø–æ –ø–æ–∏—Å–∫—É -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5>‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞</h5>
                </div>
                <div class="card-body">
                    <h6>–ù–æ–º–µ—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π:</h6>
                    <p class="small">–ï—Å–ª–∏ –≤ –Ω–æ–º–µ—Ä–µ –¥–≤–∏–≥–∞—Ç–µ–ª—è –µ—Å—Ç—å –±—É–∫–≤—ã, –≤–≤–æ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é - —Å –ê–ù–ì–õ–ò–ô–°–ö–ò–ú–ò –±—É–∫–≤–∞–º–∏.</p>

                    <h6>–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫:</h6>
                    <p class="small">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö/–Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ —Å ID –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>

                    <h6>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç:</h6>
                    <p class="small">–°–æ–∑–¥–∞–µ—Ç TXT —Ñ–∞–π–ª —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è—Ö –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π.</p>

                    <h6>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:</h6>
                    <p class="small">–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞ –≤ –ø–∞–ø–∫–µ.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    {% if messages %}
    <div class="row">
        <div class="col-12">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ -->
    {% if search_results %}
    <div class="row">
        <div class="col-12">
            <div class="card" id="search-results-card" data-scroll-to>
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —Å—Ç–∏–ª–µ alert-success –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="alert alert-success mb-0">
                    <h5 class="mb-1">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h5>
                    {% if search_results.engine_numbers %}
                        <small>–î–≤–∏–≥–∞—Ç–µ–ª–∏: {{ search_results.engine_numbers }}</small><br>
                    {% endif %}
                    {% if search_results.act_numbers %}
                        <small>–ê–∫—Ç—ã: {{ search_results.act_numbers }}</small>
                    {% endif %}
                </div>

                <div class="card-body">
                    {% if search_results.results %}
                        <div class="row">
                            {% for result in search_results.results %}
                                <div class="col-md-6 mb-2">
                                    {% if result.found == False %}
                                        <!-- –ù–µ –Ω–∞–π–¥–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å -->
                                        <div class="alert alert-warning py-2 mb-1">
                                            {{ result.message }}
                                        </div>
                                    {% else %}
                                        <!-- –ù–∞–π–¥–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å -->
                                        <div class="alert alert-success py-2 mb-1">
                                            {% if result.type == 'engine' %}–î–≤–∏–≥–∞—Ç–µ–ª—å{% else %}–ê–∫—Ç{% endif %}
                                            {{ result.found_value }} | —Å—Ç—Ä–æ–∫–∞ {{ result.record_id }} | {{ result.product_info }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ -->
                        <div class="mt-3">
                            <p class="text-muted">–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ.</p>
                        </div>
                    {% else %}
                        <p class="text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Ç–æ–≤–æ–º –æ—Ç—á–µ—Ç–µ -->
    {% if download_info %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-success" id="report-ready-card" data-scroll-to>
                <div class="card-header bg-success text-white">
                    <h5>‚úÖ –û—Ç—á–µ—Ç –≥–æ—Ç–æ–≤</h5>
                </div>
                <div class="card-body">
                    <p><strong>{{ download_info.message }}</strong></p>
                    <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: <strong>{{ download_info.records_count }}</strong></p>

                    <div class="d-flex gap-2 mt-3">
                        <a href="{% url 'reports:download_search_report' %}" target="_blank" class="btn btn-success">
                            üíæ –û—Ç–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç
                        </a>
                        <button class="btn btn-secondary" onclick="this.closest('.card').style.display='none'">
                            ‚ùå –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<script>
function clearForm() {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º clear=1 –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–µ—Å—Å–∏–∏
    window.location.href = '{% url "reports:db_search" %}?clear=1';
}

function scrollToElement(elementId, delay = 100) {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫ —ç–ª–µ–º–µ–Ω—Ç—É —Å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º data-scroll-to –≤ —Ç–µ–≥–µ
    setTimeout(function() {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
            element.setAttribute('tabindex', '-1');
            element.focus();
        }
    }, delay);
}

document.addEventListener('DOMContentLoaded', function() {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å data-scroll-to
    const elementsToScroll = document.querySelectorAll('[data-scroll-to]');
    elementsToScroll.forEach(function(element) {
        scrollToElement(element.id);
    });
});
</script>
{% endblock %}