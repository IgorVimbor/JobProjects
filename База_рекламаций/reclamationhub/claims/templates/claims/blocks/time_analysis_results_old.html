<!-- claims/templates/claims/blocks/time_analysis_results.html -->
<!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ ‚Üí —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è ‚Üí –ø—Ä–µ—Ç–µ–Ω–∑–∏—è -->

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <strong>
                {% if time_analysis_data.all_consumers_mode %}
                    ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –ø–æ –≤—Å–µ–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º –∑–∞ {{ time_analysis_data.year }} –≥–æ–¥
                {% elif time_analysis_data.consumers|length == 1 %}
                    ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –ø–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—é "{{ time_analysis_data.consumers.0 }}" –∑–∞ {{ time_analysis_data.year }} –≥–æ–¥
                {% else %}
                    ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –ø–æ {{ time_analysis_data.consumers|length }} –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º –∑–∞ {{ time_analysis_data.year }} –≥–æ–¥
                {% endif %}
            </strong>
            <br>
            <small>–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –¥–∞—Ç–∞–º: –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ ‚Üí —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è ‚Üí –ø—Ä–µ—Ç–µ–Ω–∑–∏—è</small>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º: –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ ‚Üí —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è ‚Üí –ø—Ä–µ—Ç–µ–Ω–∑–∏—è</h5>
            </div>
            <div class="card-body">
                <canvas id="timeAnalysisChart" height="80"></canvas>

                <!-- –õ–µ–≥–µ–Ω–¥–∞ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è -->
                <div class="mt-3">
                    <div class="alert alert-light">
                        <h6 class="mb-2">‚ÑπÔ∏è –ü–æ—è—Å–Ω–µ–Ω–∏–µ –∫ –≥—Ä–∞—Ñ–∏–∫—É:</h6>
                        <ul class="small mb-0">
                            <li><strong style="color: #4CAF50;">‚ñ† –ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:</strong> –î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –∏–∑–¥–µ–ª–∏–π (–∏–∑ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π)</li>
                            <li><strong style="color: #FF9800;">‚ñ† –†–µ–∫–ª–∞–º–∞—Ü–∏–∏:</strong> –î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –¥–µ—Ñ–µ–∫—Ç–µ</li>
                            <li><strong style="color: #F44336;">‚ñ† –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏:</strong> –î–∞—Ç–∞ –ø—Ä–∏–∑–Ω–∞–Ω–Ω—ã—Ö –ø—Ä–µ—Ç–µ–Ω–∑–∏–π</li>
                        </ul>
                        <p class="small text-muted mb-0 mt-2">
                            <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –†–µ–∫–ª–∞–º–∞—Ü–∏–∏ –±–µ–∑ –¥–∞—Ç—ã –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–µ—Ä–∏—è—Ö "–†–µ–∫–ª–∞–º–∞—Ü–∏–∏" –∏ "–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏".
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
<div class="row mt-3 mb-4">
    <div class="col-12">
        <div class="d-flex gap-2">
            <a href="{% url 'claims:time_analysis' %}" class="btn btn-primary">
                üîÑ –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
            </a>
            <button class="btn btn-secondary" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                ‚¨ÜÔ∏è –í–≤–µ—Ä—Ö
            </button>

            <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ -->
            <a href="{% url 'claims:reclamation_to_claim' %}" class="btn btn-outline-primary">
                üìä –ü–µ—Ä–µ–π—Ç–∏ –∫ –∞–Ω–∞–ª–∏–∑—É –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
            </a>

            <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª—ã -->
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="year" value="{{ time_analysis_data.year }}">
                {% for consumer in time_analysis_data.consumers %}
                <input type="hidden" name="consumers" value="{{ consumer }}">
                {% endfor %}
                <button type="submit" class="btn btn-outline-primary" name="action" value="save_files">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫
                </button>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('timeAnalysisChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ time_analysis_data.monthly_data.labels_formatted|safe }},
            datasets: [
                {
                    label: '–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–æ',
                    data: {{ time_analysis_data.monthly_data.manufacture|safe }},
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderColor: 'rgb(76, 175, 80)',
                    borderWidth: 1
                },
                {
                    label: '–†–µ–∫–ª–∞–º–∞—Ü–∏–∏',
                    data: {{ time_analysis_data.monthly_data.reclamations|safe }},
                    backgroundColor: 'rgba(255, 152, 0, 0.7)',
                    borderColor: 'rgb(255, 152, 0)',
                    borderWidth: 1
                },
                {
                    label: '–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏',
                    data: {{ time_analysis_data.monthly_data.claims|safe }},
                    backgroundColor: 'rgba(244, 67, 54, 0.7)',
                    borderColor: 'rgb(244, 67, 54)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' }
                    }
                },
                title: {
                    display: true,
                    text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–¥–µ–ª–∏–π, —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π –∏ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' —à—Ç.';
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '–ü–µ—Ä–∏–æ–¥',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç.)',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        }
                    }
                }
            }
        }
    });
});
</script>