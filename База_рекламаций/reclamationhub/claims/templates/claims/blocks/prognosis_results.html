<!-- claims/templates/claims/blocks/prognosis_results.html -->

{% load static %}

<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0">
                üìä –ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è {{ prognosis_data.consumer_display }}
            </h4>
            <small class="text-muted">
                –ë–∞–∑–∞: {{ prognosis_data.year }} –≥–æ–¥ |
                –ü—Ä–æ–≥–Ω–æ–∑: {{ prognosis_data.forecast_months }} –º–µ—Å.
            </small>
        </div>
        <div class="d-flex gap-2">
            <!-- –§–æ—Ä–º–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ -->
            <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="year" value="{{ prognosis_data.year }}">
                <input type="hidden" name="forecast_months" value="{{ prognosis_data.forecast_months }}">
                <input type="hidden" name="exchange_rate" value="{{ prognosis_data.exchange_rate }}">
                {% for consumer in prognosis_data.consumers %}
                    <input type="hidden" name="consumers" value="{{ consumer }}">
                {% endfor %}
                <button type="submit" name="action" value="save_files" class="btn btn-success">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª—ã
                </button>
            </form>

            <!-- –ö–Ω–æ–ø–∫–∞ –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ -->
            <a href="{% url 'claims:claim_prognosis' %}" class="btn btn-secondary">
                üîÑ –ù–æ–≤—ã–π –ø—Ä–æ–≥–Ω–æ–∑
            </a>
        </div>
    </div>
</div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ -->
<div class="row mb-4">
    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 1: –ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ -->
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">üìä –ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏</h6>
                <h2 class="card-title text-primary">
                    {{ prognosis_data.conversion_params.conversion_rate|floatformat:1 }}%
                </h2>
                <p class="card-text small">
                    {{ prognosis_data.conversion_params.escalated_reclamations }} –∏–∑
                    {{ prognosis_data.conversion_params.total_reclamations }} —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π
                </p>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 2: –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ -->
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">‚è±Ô∏è –í—Ä–µ–º—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏</h6>
                <h2 class="card-title text-warning">
                    {{ prognosis_data.conversion_params.escalation_days }}
                </h2>
                <p class="card-text small">
                    –¥–Ω–µ–π ({{ prognosis_data.conversion_params.escalation_days|floatformat:0|add:"0"|divisibleby:30|yesno:"~4,~3,~5" }} –º–µ—Å—è—Ü–∞)
                </p>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 3: –ü—Ä–æ–≥–Ω–æ–∑ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π -->
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">üîÆ –ü—Ä–æ–≥–Ω–æ–∑ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π</h6>
                <h2 class="card-title text-info">
                    {{ prognosis_data.total_reclamations_forecast }}
                </h2>
                <p class="card-text small">
                    –Ω–∞ {{ prognosis_data.forecast_months }} –º–µ—Å.
                </p>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 4: –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π -->
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">üéØ –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π</h6>
                <h2 class="card-title text-danger">
                    {{ prognosis_data.total_claims_forecast }}
                </h2>
                <p class="card-text small">
                    –æ–∂–∏–¥–∞–µ—Ç—Å—è (—Å —É—á–µ—Ç–æ–º –ª–∞–≥–∞)
                </p>
            </div>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>üìà –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥–Ω–æ–∑–∞ (—Ñ–∞–∫—Ç + –ø—Ä–æ–≥–Ω–æ–∑)</h5>
            </div>
            <div class="card-body">
                <canvas id="prognosisChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>üìã –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –º–µ—Å—è—Ü–∞–º</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>–ü–µ—Ä–∏–æ–¥</th>
                                <th class="text-center">–†–µ–∫–ª–∞–º–∞—Ü–∏–∏ (—Ñ–∞–∫—Ç)</th>
                                <th class="text-center">–†–µ–∫–ª–∞–º–∞—Ü–∏–∏ (–ø—Ä–æ–≥–Ω–æ–∑)</th>
                                <th class="text-center">–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (—Ñ–∞–∫—Ç)</th>
                                <th class="text-center">–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (–ø—Ä–æ–≥–Ω–æ–∑)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in prognosis_data.combined_data.table_data %}
                            <tr>
                                <td>
                                    <strong>{{ row.label_formatted }}</strong>
                                </td>
                                <td class="text-center">
                                    {% if row.reclamation_fact > 0 %}
                                        <span class="badge bg-warning">{{ row.reclamation_fact }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if row.reclamation_forecast > 0 %}
                                        <span class="badge bg-info">{{ row.reclamation_forecast }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if row.claim_fact > 0 %}
                                        <span class="badge bg-danger">{{ row.claim_fact }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if row.claim_forecast > 0 %}
                                        <span class="badge bg-secondary">{{ row.claim_forecast }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('prognosisChart').getContext('2d');

    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ prognosis_data.combined_data.labels_formatted|safe }},
            datasets: [
                {
                    label: '–†–µ–∫–ª–∞–º–∞—Ü–∏–∏ (—Ñ–∞–∫—Ç)',
                    data: {{ prognosis_data.combined_data.reclamations_fact|safe }},
                    backgroundColor: 'rgba(255, 152, 0, 0.8)',
                    borderColor: 'rgba(255, 152, 0, 1)',
                    borderWidth: 1,
                },
                {
                    label: '–†–µ–∫–ª–∞–º–∞—Ü–∏–∏ (–ø—Ä–æ–≥–Ω–æ–∑)',
                    data: {{ prognosis_data.combined_data.reclamations_forecast|safe }},
                    backgroundColor: 'rgba(255, 224, 178, 0.6)',
                    borderColor: 'rgba(255, 152, 0, 1)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                },
                {
                    label: '–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (—Ñ–∞–∫—Ç)',
                    data: {{ prognosis_data.combined_data.claims_fact|safe }},
                    backgroundColor: 'rgba(244, 67, 54, 0.8)',
                    borderColor: 'rgba(244, 67, 54, 1)',
                    borderWidth: 1,
                },
                {
                    label: '–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (–ø—Ä–æ–≥–Ω–æ–∑)',
                    data: {{ prognosis_data.combined_data.claims_forecast|safe }},
                    backgroundColor: 'rgba(255, 205, 210, 0.6)',
                    borderColor: 'rgba(244, 67, 54, 1)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                },
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                title: {
                    display: true,
                    text: '–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π: {{ prognosis_data.consumer_display }} ({{ prognosis_data.year }} + {{ prognosis_data.forecast_months }} –º–µ—Å.)',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y + ' —à—Ç.';
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: false,
                    title: {
                        display: true,
                        text: '–ü–µ—Ä–∏–æ–¥'
                    }
                },
                y: {
                    stacked: false,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç.)'
                    },
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
});
</script>
