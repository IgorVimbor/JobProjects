<!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–∞ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π –∏ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π -->
<!-- claims/templates/claims/blocks/prognosis_results.html -->

{% load static %}

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-success">
            –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ <strong>{{ prognosis_data.forecast_months }} –º–µ—Å.</strong> –¥–ª—è <strong>{{ prognosis_data.consumer_display }}</strong>
            <br>
            <small>
                –ë–∞–∑–∞: <strong>{{ prognosis_data.year }}</strong> –≥–æ–¥.
                {% comment %} <br> {% endcomment %}
                –ú–µ—Ç–æ–¥: <strong>{{ prognosis_data.forecast_display }}</strong>
            </small>
        </div>
    </div>
</div>

<!-- –ê–Ω–∞–ª–∏–∑ —Å–≤—è–∑–∏ –¥–ª—è linked –º–µ—Ç–æ–¥–∞ -->
{% if prognosis_data.forecast_method == 'linked' and prognosis_data.correlation_analysis %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    üìà –ê–Ω–∞–ª–∏–∑ —Å–≤—è–∑–∏ –†–µ–∫–ª–∞–º–∞—Ü–∏–∏ ‚Üí –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ –¥–ª—è linked –º–µ—Ç–æ–¥–∞
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ª–∞–≥ -->
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card border-primary rounded p-3 text-center h-100">
                            <h6 class="card-subtitle mb-2 text-muted">–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∞–≥</h6>
                            <div class="display-6 text-primary mb-1">
                                {{ prognosis_data.correlation_analysis.optimal_lag }} –º–µ—Å.
                            </div>
                            <div class="text-muted small">
                                —Ä–µ–∫–ª–∞–º–∞—Ü–∏–∏ + –ª–∞–≥ ‚Üí –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏ <!-- —á–µ—Ä–µ–∑ {{ prognosis_data.correlation_analysis.optimal_lag }} –º–µ—Å. -->
                            </div>
                        </div>
                    </div>

                    <!-- –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è -->
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card border-warning rounded p-3 text-center h-100">
                            <h6 class="card-subtitle mb-2 text-muted">–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è</h6>
                            <div class="display-6 mb-1
                                {% if prognosis_data.correlation_analysis.optimal_correlation >= 0.7 %}text-success
                                {% elif prognosis_data.correlation_analysis.optimal_correlation >= 0.5 %}text-warning
                                {% else %}text-danger{% endif %}">
                                {{ prognosis_data.correlation_analysis.optimal_correlation|floatformat:4 }}
                            </div>
                            <div class="text-muted small">
                                {{ prognosis_data.correlation_analysis.interpretation|default:"" }}
                            </div>
                        </div>
                    </div>

                    <!-- –ö–æ–Ω–≤–µ—Ä—Å–∏—è -->
                    {% comment %} <div class="col-md-3 mb-3">
                        <div class="border rounded p-3 text-center h-100">
                            <div class="text-muted small">–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏</div>
                            <div class="display-6 text-warning mb-1">
                                {{ prognosis_data.linked_model.conversion.rate_pct }}
                            </div>
                            <div class="text-muted small">
                                —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø—Ä–µ—Ç–µ–Ω–∑–∏—è–º–∏
                            </div>
                        </div>
                    </div> {% endcomment %}

                    <!-- –ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏ -->
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card border-info rounded p-3 text-center h-100">
                            <h6 class="card-subtitle mb-2 text-muted">–ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏ (R¬≤)</h6>
                            <div class="display-6 mb-1
                                {% if prognosis_data.linked_model.model_quality.r_squared >= 0.7 %}text-success
                                {% elif prognosis_data.linked_model.model_quality.r_squared >= 0.5 %}text-warning
                                {% else %}text-danger{% endif %}">
                                {{ prognosis_data.linked_model.model_quality.r_squared|floatformat:3 }}
                            </div>
                            <div class="text-muted small">
                                {{ prognosis_data.linked_model.model_quality.quality_interpretation }}
                            </div>
                        </div>
                    </div>

                    <!-- –°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏ -->
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card border-success rounded p-3 text-center h-100">
                            <h6 class="card-subtitle mb-2 text-muted">–°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏</h6>
                            <div class="display-6 text-success mb-1">
                                {{ prognosis_data.linked_model.claim_amount.average|floatformat:2 }} BYN
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π –ø–æ –ª–∞–≥–∞–º (—Å–≤—ë—Ä–Ω—É—Ç–∞—è) -->
                <div class="mt-3">
                    <button class="btn btn-outline-primary flex-fill" type="button"
                            data-bs-toggle="collapse" data-bs-target="#lagDetails">
                        –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –ø–æ –≤—Å–µ–º –ª–∞–≥–∞–º
                    </button>
                    <div class="collapse mt-2" id="lagDetails">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>–í—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∞–≥ (–∫–æ–ª-–≤–æ –º–µ—Å—è—Ü–µ–≤)</th>
                                        {% for lag_data in prognosis_data.correlation_analysis.all_lags %}
                                        <th class="text-center
                                            {% if lag_data.lag == prognosis_data.correlation_analysis.optimal_lag %}table-primary{% endif %}">
                                            {{ lag_data.lag }}
                                        </th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è</td>
                                        {% for lag_data in prognosis_data.correlation_analysis.all_lags %}
                                        <td class="text-center
                                            {% if lag_data.lag == prognosis_data.correlation_analysis.optimal_lag %}table-primary fw-bold{% endif %}">
                                            {{ lag_data.correlation }}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        <td>–ó–Ω–∞—á–∏–º–æ—Å—Ç—å</td>
                                        {% for lag_data in prognosis_data.correlation_analysis.all_lags %}
                                        <td class="text-center">
                                            {% if lag_data.significant %}
                                            <span class="badge bg-success">‚úì</span>
                                            {% else %}
                                            <span class="badge bg-secondary">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- –°–µ–∑–æ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è seasonal/linked -->
{% if prognosis_data.seasonality_pattern %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    üìà –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π - –∏–Ω–¥–µ–∫—Å –º–µ—Å—è—Ü–∞
                    <small class="text-muted ms-2">
                        (–∏–Ω–¥–µ–∫—Å > 1 = –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ, < 1 = –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ)
                    </small>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for month, index in prognosis_data.seasonality_pattern.items %}
                    <div class="col-md-1 col-sm-2 col-3 mb-2 text-center">
                        <div class="border rounded p-2
                            {% if index >= 1.2 %}bg-danger bg-opacity-25
                            {% elif index >= 1.0 %}bg-warning bg-opacity-25
                            {% elif index >= 0.8 %}bg-success bg-opacity-25
                            {% else %}bg-info bg-opacity-25{% endif %}">
                            <div class="small text-muted">{{ month }}</div>
                            <div class="fw-bold">{{ index }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-2 small text-muted">
                    <span class="badge bg-danger bg-opacity-50 me-1">‚â•1.2</span> –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
                    <span class="badge bg-warning bg-opacity-50 mx-1">1.0-1.2</span> –í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ
                    <span class="badge bg-success bg-opacity-50 mx-1">0.8-1.0</span> –ù–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ
                    <span class="badge bg-info bg-opacity-50 mx-1">&lt;0.8</span> –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- –§–æ—Ä–º—É–ª–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ -->
{% if prognosis_data.linked_model.regression.formula %}
<div class="mt-3 mb-2 p-3 bg-light rounded">
    <div class="row align-items-center">
        <div class="col-md-8">
            <strong>üìä –§–æ—Ä–º—É–ª–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞:</strong>
            {% comment %} <code class="ms-2 fs-6">{{ prognosis_data.linked_model.regression.formula }}</code> {% endcomment %}
            <strong><span class="text-success">{{ prognosis_data.linked_model.regression.formula }}</span></strong>
        </div>
    </div>
</div>
{% endif %}

<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ -->
<div class="row mb-3">
    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 1: –ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-primary text-center h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏</h6>
                <h2 class="display-6 text-primary mb-1">
                    {{ prognosis_data.conversion_params.conversion_rate|floatformat:1 }}%
                </h2>
                <p class="card-text small">
                    {{ prognosis_data.conversion_params.escalated_reclamations }} —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π
                    –∏–∑ {{ prognosis_data.conversion_params.total_reclamations }} ‚Üí –≤ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏
                </p>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 2: –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ -->
    {% comment %} <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-warning h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏</h6>
                <h2 class="card-title text-warning">
                    {{ prognosis_data.conversion_params.escalation_days }}
                </h2>
                <p class="card-text small">
                    –¥–Ω–µ–π –æ—Ç —Ä–µ–∫–ª–∞–º–∞—Ü–∏–∏ –¥–æ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏
                </p>
            </div>
        </div>
    </div> {% endcomment %}

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 2: –ü—Ä–æ–≥–Ω–æ–∑ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-warning text-center h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">–ü—Ä–æ–≥–Ω–æ–∑ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π</h6>
                <h2 class="display-6 text-warning mb-1">
                    {{ prognosis_data.total_reclamations_forecast }}
                </h2>
                <p class="card-text small">
                    –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞ {{ prognosis_data.forecast_months }} –º–µ—Å.
                </p>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 3: –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-info text-center h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π</h6>
                <h2 class="display-6 text-info mb-1">
                    {{ prognosis_data.total_claims_forecast }}
                </h2>
                <p class="card-text small">
                    –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞ {{ prognosis_data.forecast_months }} –º–µ—Å.
                </p>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 4: –ü—Ä–æ–≥–Ω–æ–∑ —Å—É–º–º –ø—Ä–µ—Ç–µ–Ω–∑–∏–π -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-success text-center h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">–ü—Ä–æ–≥–Ω–æ–∑ —Å—É–º–º –ø—Ä–µ—Ç–µ–Ω–∑–∏–π</h6>
                <h2 class="display-6 text-success mb-1">
                    {{ prognosis_data.total_claims_costs_forecast|floatformat:2 }} BYN
                </h2>
                <p class="card-text small">
                    –æ–∂–∏–¥–∞–µ–º–∞—è —Å—É–º–º–∞ –∑–∞ {{ prognosis_data.forecast_months }} –º–µ—Å.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">üìà –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥–Ω–æ–∑–∞ (—Ñ–∞–∫—Ç + –ø—Ä–æ–≥–Ω–æ–∑)</h5>
                    <small class="text-muted">
                        –ú–µ—Ç–æ–¥: {{ prognosis_data.forecast_display }}
                    </small>
                </div>
                {% if prognosis_data.forecast_method == 'linked' %}
                <div>
                    <span>
                        <small class="text-muted">–ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏ R¬≤ =</small>
                        {% with r2=prognosis_data.linked_model.model_quality.r_squared %}
                            <span class="{% if r2 >= 0.7 %}text-success{% elif r2 >= 0.5 %}text-warning{% else %}text-danger{% endif %}">
                                {{ r2|floatformat:3 }}
                            </span>
                        {% endwith %}
                    </span>
                    <br>
                    <span>
                        <small class="text-muted">–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (95%) =</small>
                        <span class="text-success">{{ prognosis_data.total_claims_costs_ci_lower|floatformat:2 }}</span>
                        √∑
                        <span class="text-success">{{ prognosis_data.total_claims_costs_ci_upper|floatformat:2 }}</span>
                        <span class="text-success">BYN</span>
                    </span>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                <canvas id="prognosisChart" height="160"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>üìã –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –º–µ—Å—è—Ü–∞–º</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th rowspan="2" class="align-middle">–ü–µ—Ä–∏–æ–¥</th>
                                <th colspan="2" class="text-center">–†–µ–∫–ª–∞–º–∞—Ü–∏–∏</th>
                                <th colspan="2" class="text-center">–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (–∫–æ–ª-–≤–æ)</th>
                                <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è linked -->
                                {% if prognosis_data.forecast_method == 'linked' %}
                                <th colspan="3" class="text-center">–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (—Å—É–º–º—ã, BYN)</th>
                                {% else %}
                                <th colspan="2" class="text-center">–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (—Å—É–º–º—ã, BYN)</th>
                                {% endif %}
                            </tr>
                            <tr>
                                <th class="text-center">–§–∞–∫—Ç</th>
                                <th class="text-center text-success">–ü—Ä–æ–≥–Ω–æ–∑</th>
                                <th class="text-center">–§–∞–∫—Ç</th>
                                <th class="text-center text-success">–ü—Ä–æ–≥–Ω–æ–∑</th>
                                <th class="text-center">–§–∞–∫—Ç</th>
                                <th class="text-center text-success">–ü—Ä–æ–≥–Ω–æ–∑</th>
                                {% if prognosis_data.forecast_method == 'linked' %}
                                <th class="text-center text-info">–ò–Ω—Ç–µ—Ä–≤–∞–ª (95%)</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in prognosis_data.combined_data.table_data %}
                            <tr>
                                <td><strong>{{ row.label_formatted }}</strong></td>

                                <!-- –†–µ–∫–ª–∞–º–∞—Ü–∏–∏ —Ñ–∞–∫—Ç -->
                                <td class="text-center">
                                    {% if row.reclamation_fact > 0 %}
                                        <span>{{ row.reclamation_fact }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>

                                <!-- –†–µ–∫–ª–∞–º–∞—Ü–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑ -->
                                <td class="text-center text-success">
                                    {% if row.reclamation_forecast > 0 %}
                                        <span><strong>{{ row.reclamation_forecast }}</strong></span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>

                                <!-- –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ —Ñ–∞–∫—Ç -->
                                <td class="text-center">
                                    {% if row.claim_fact > 0 %}
                                        <span>{{ row.claim_fact }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>

                                <!-- –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑ -->
                                <td class="text-center text-success">
                                    {% if row.claim_forecast > 0 %}
                                        <span><strong>{{ row.claim_forecast }}</strong></span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>

                                <!-- –°—É–º–º—ã —Ñ–∞–∫—Ç -->
                                <td class="text-center">
                                    {% if row.claim_cost_fact > 0 %}
                                        <span>{{ row.claim_cost_fact|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>

                                <!-- –°—É–º–º—ã –ø—Ä–æ–≥–Ω–æ–∑ -->
                                <td class="text-center text-success">
                                    {% if row.claim_cost_forecast > 0 %}
                                        <span><strong>{{ row.claim_cost_forecast|floatformat:2 }}</strong></span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>

                                <!-- –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (—Ç–æ–ª—å–∫–æ –¥–ª—è linked) -->
                                {% if prognosis_data.forecast_method == 'linked' %}
                                <td class="text-center text-info small">
                                    {% if row.claim_cost_ci_lower and row.claim_cost_ci_upper %}
                                        {{ row.claim_cost_ci_lower|floatformat:0 }}‚Äì{{ row.claim_cost_ci_upper|floatformat:0 }}
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>

                        <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
                        <tfoot class="table-secondary">
                            <tr>
                                <td><strong>–ò–¢–û–ì–û (–ø—Ä–æ–≥–Ω–æ–∑)</strong></td>
                                <td class="text-center">‚Äî</td>
                                <td class="text-center text-success"><strong>{{ prognosis_data.total_reclamations_forecast }}</strong></td>
                                <td class="text-center">‚Äî</td>
                                <td class="text-center text-success"><strong>{{ prognosis_data.total_claims_forecast }}</strong></td>
                                <td class="text-center">‚Äî</td>
                                <td class="text-center text-success"><strong>{{ prognosis_data.total_claims_costs_forecast|floatformat:2 }}</strong></td>
                                {% if prognosis_data.forecast_method == 'linked' %}
                                <td class="text-center">‚Äî</td>
                                {% endif %}
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
<div class="row mt-3 mb-4">
    <div class="col-12">
        <div class="d-flex gap-2 justify-content-end flex-wrap">
            <a href="{% url 'claims:claim_prognosis' %}" class="btn btn-primary">
                üîÑ –ù–æ–≤—ã–π –ø—Ä–æ–≥–Ω–æ–∑
            </a>
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª—ã -->
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="year" value="{{ prognosis_data.year }}">
                <input type="hidden" name="forecast_months" value="{{ prognosis_data.forecast_months }}">
                <input type="hidden" name="exchange_rate" value="{{ prognosis_data.exchange_rate }}">
                <input type="hidden" name="forecast_method" value="{{ prognosis_data.forecast_method }}">
                <input type="hidden" name="statistical_mode" value="{{ prognosis_data.statistical_mode }}">
                <input type="hidden" name="ml_model" value="{{ prognosis_data.ml_model }}">
                <input type="hidden" name="seasonal_type" value="{{ prognosis_data.seasonal_type }}">
                {% for consumer in prognosis_data.consumers %}
                    <input type="hidden" name="consumers" value="{{ consumer }}">
                {% endfor %}
                <button type="submit" class="btn btn-outline-primary" name="action" value="save_files">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª
                </button>
            </form>
            <button class="btn btn-outline-secondary" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                ‚¨ÜÔ∏è –í–≤–µ—Ä—Ö
            </button>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('prognosisChart').getContext('2d');

    // –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    const labels = {{ prognosis_data.combined_data.labels|safe }};
    const datasets = [
        // ========== –õ–ï–í–ê–Ø –û–°–¨ Y (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ) ==========

        // 1. –†–µ–∫–ª–∞–º–∞—Ü–∏–∏ (—Ñ–∞–∫—Ç)
        {
            label: '–†–µ–∫–ª–∞–º–∞—Ü–∏–∏ (—Ñ–∞–∫—Ç)',
            data: {{ prognosis_data.combined_data.reclamations_fact|safe }},
            borderColor: 'rgb(255, 193, 7)',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.3,
            fill: true,
            yAxisID: 'y',
            datalabels: {
                anchor: 'end',
                align: 'top',
                color: 'rgb(204, 102, 0)',
                font: { weight: 'normal', size: 10 },
                formatter: function(value) {
                    return value === 0 ? '' : value;
                }
            }
        },

        // 2. –†–µ–∫–ª–∞–º–∞—Ü–∏–∏ (–ø—Ä–æ–≥–Ω–æ–∑)
        {
            label: '–†–µ–∫–ª–∞–º–∞—Ü–∏–∏ (–ø—Ä–æ–≥–Ω–æ–∑)',
            data: {{ prognosis_data.combined_data.reclamations_forecast|safe }},
            borderColor: 'rgba(255, 193, 7, 1)',
            backgroundColor: 'rgba(255, 193, 7, 0.2)',
            borderDash: [5, 5],
            tension: 0.3,
            fill: true,
            yAxisID: 'y',
            datalabels: {
                anchor: 'end',
                align: 'top',
                color: 'rgb(204, 102, 0)',
                font: { weight: 'normal', size: 10 },
                formatter: function(value) {
                    return value === 0 ? '' : value;
                }
            }
        },

        // 3. –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (—Ñ–∞–∫—Ç)
        {
            label: '–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (—Ñ–∞–∫—Ç)',
            data: {{ prognosis_data.combined_data.claims_fact|safe }},
            borderColor: 'rgb(244, 67, 54)',
            backgroundColor: 'rgba(244, 67, 54, 0.1)',
            tension: 0.3,
            fill: true,
            yAxisID: 'y',
            datalabels: {
                anchor: 'end',
                align: 'top',
                color: 'rgb(198, 40, 40)',
                font: { weight: 'normal', size: 10 },
                formatter: function(value) {
                    return value === 0 ? '' : value;
                }
            }
        },

        // 4. –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (–ø—Ä–æ–≥–Ω–æ–∑)
        {
            label: '–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏ (–ø—Ä–æ–≥–Ω–æ–∑)',
            data: {{ prognosis_data.combined_data.claims_forecast|safe }},
            borderColor: 'rgba(244, 67, 54, 1)',
            backgroundColor: 'rgba(244, 67, 54, 0.2)',
            borderDash: [5, 5],
            tension: 0.3,
            fill: true,
            yAxisID: 'y',
            datalabels: {
                anchor: 'end',
                align: 'top',
                color: 'rgb(198, 40, 40)',
                font: { weight: 'normal', size: 10 },
                formatter: function(value) {
                    return value === 0 ? '' : value;
                }
            }
        },

        // ========== –ü–†–ê–í–ê–Ø –û–°–¨ Y1 (—Å—É–º–º—ã) ==========

        // 5. –°—É–º–º—ã –ø—Ä–µ—Ç–µ–Ω–∑–∏–π (—Ñ–∞–∫—Ç)
        {
            label: '–°—É–º–º–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π (—Ñ–∞–∫—Ç, BYN)',
            data: {{ prognosis_data.combined_data.claims_costs_fact|safe }},
            borderColor: 'rgb(25, 135, 84)',
            backgroundColor: 'rgba(25, 135, 84, 0.1)',
            tension: 0.3,
            fill: true,
            yAxisID: 'y1',
            datalabels: {
                anchor: 'end',
                align: 'top',
                color: 'rgb(25, 135, 84)',
                font: { weight: 'normal', size: 10 },
                formatter: function(value) {
                    return value === 0 ? '' : value.toFixed(0);
                }
            }
        },

        // 6. –°—É–º–º—ã –ø—Ä–µ—Ç–µ–Ω–∑–∏–π (–ø—Ä–æ–≥–Ω–æ–∑)
        {
            label: '–°—É–º–º–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π (–ø—Ä–æ–≥–Ω–æ–∑, BYN)',
            data: {{ prognosis_data.combined_data.claims_costs_forecast|safe }},
            borderColor: 'rgba(25, 135, 84, 1)',
            backgroundColor: 'rgba(25, 135, 84, 0.2)',
            borderDash: [5, 5],
            tension: 0.3,
            fill: true,
            yAxisID: 'y1',
            datalabels: {
                anchor: 'end',
                align: 'top',
                color: 'rgb(25, 135, 84)',
                font: { weight: 'normal', size: 10 },
                formatter: function(value) {
                    return value === 0 ? '' : value.toFixed(0);
                }
            }
        }
    ];

    {% if prognosis_data.forecast_method == 'linked' and prognosis_data.combined_data.claims_costs_ci_lower %}
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è linked –º–µ—Ç–æ–¥–∞
    datasets.push({
        label: '–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≤–µ—Ä—Ö)',
        data: {{ prognosis_data.combined_data.claims_costs_ci_upper|safe }},
        borderColor: 'rgba(25, 135, 84, 0.3)',
        backgroundColor: 'transparent',
        borderDash: [2, 2],
        tension: 0.3,
        fill: false,
        yAxisID: 'y1',
        pointRadius: 0,
        datalabels: { display: false }
    });

    datasets.push({
        label: '–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–Ω–∏–∑)',
        data: {{ prognosis_data.combined_data.claims_costs_ci_lower|safe }},
        borderColor: 'rgba(25, 135, 84, 0.3)',
        backgroundColor: 'rgba(25, 135, 84, 0.1)',
        borderDash: [2, 2],
        tension: 0.3,
        fill: '-1',  // –ó–∞–ª–∏–≤–∫–∞ –¥–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞
        yAxisID: 'y1',
        pointRadius: 0,
        datalabels: { display: false }
    });
    {% endif %}

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 11, weight: 'bold' },
                        filter: function(item, chart) {
                            // –°–∫—Ä—ã–≤–∞–µ–º CI –ª–∏–Ω–∏–∏ –∏–∑ –ª–µ–≥–µ–Ω–¥—ã
                            return !item.text.includes('–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª');
                        }
                    },
                },
                title: {
                    display: true,
                    text: '–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π: {{ prognosis_data.consumer_display }} ({{ prognosis_data.year }} + {{ prognosis_data.forecast_months }} –º–µ—Å.)',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label.includes('–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª')) {
                                return null;  // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º CI –≤ tooltip
                            }
                            if (label) {
                                label += ': ';
                            }

                            if (context.dataset.yAxisID === 'y1') {
                                label += context.parsed.y.toFixed(2) + ' BYN';
                            } else {
                                label += context.parsed.y + ' —à—Ç.';
                            }

                            return label;
                        }
                    }
                },
                datalabels: {
                    display: true
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '–ü–µ—Ä–∏–æ–¥ (–≥–æ–¥-–º–µ—Å—è—Ü)',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 90,
                        minRotation: 90
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    grace: '10%',
                    title: {
                        display: true,
                        text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç.)',
                        font: { size: 12, weight: 'bold' },
                        color: 'rgb(204, 102, 0)'
                    },
                    ticks: {
                        stepSize: 1,
                        color: 'rgb(204, 102, 0)',
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    grace: '10%',
                    title: {
                        display: true,
                        text: '–°—É–º–º–∞ (BYN)',
                        font: { size: 12, weight: 'bold' },
                        color: 'rgb(25, 135, 84)'
                    },
                    ticks: {
                        color: 'rgb(25, 135, 84)',
                        callback: function(value) {
                            return value.toLocaleString('ru-RU');
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
});
</script>