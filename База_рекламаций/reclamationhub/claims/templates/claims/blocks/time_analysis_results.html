<!-- claims/templates/claims/blocks/time_analysis_results.html -->
<!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ ‚Üí —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è ‚Üí –ø—Ä–µ—Ç–µ–Ω–∑–∏—è -->

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <strong>
                {% if time_analysis_data.all_consumers_mode %}
                    ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –ø–æ –≤—Å–µ–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º –∑–∞ {{ time_analysis_data.year }} –≥–æ–¥
                {% elif time_analysis_data.consumers|length == 1 %}
                    ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –ø–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—é "{{ time_analysis_data.consumers.0 }}" –∑–∞ {{ time_analysis_data.year }} –≥–æ–¥
                {% else %}
                    ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –ø–æ {{ time_analysis_data.consumers|length }} –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º –∑–∞ {{ time_analysis_data.year }} –≥–æ–¥
                {% endif %}
            </strong>
            <br>
            <small>–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –¥–∞—Ç–∞–º: –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ ‚Üí —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è ‚Üí –ø—Ä–µ—Ç–µ–Ω–∑–∏—è</small>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º: –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ ‚Üí —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è ‚Üí –ø—Ä–µ—Ç–µ–Ω–∑–∏—è</h5>
            </div>
            <div class="card-body">
                <!-- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –≥—Ä–∞—Ñ–∏–∫–∞ (160) -->
                <canvas id="timeAnalysisChart" height="160"></canvas>

                <!-- –õ–µ–≥–µ–Ω–¥–∞ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è -->
                <div class="mt-3">
                    <div class="alert alert-light">
                        <h6 class="mb-2">‚ÑπÔ∏è –ü–æ—è—Å–Ω–µ–Ω–∏–µ –∫ –≥—Ä–∞—Ñ–∏–∫—É:</h6>
                        <ul class="small mb-0">
                            <li><strong style="color: #4CAF50;">‚ñ† –ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:</strong> –î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –∏–∑–¥–µ–ª–∏–π (–∏–∑ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π)</li>
                            <li><strong style="color: #FF9800;">‚ñ† –†–µ–∫–ª–∞–º–∞—Ü–∏–∏:</strong> –î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –¥–µ—Ñ–µ–∫—Ç–µ</li>
                            <li><strong style="color: #F44336;">‚ñ† –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏:</strong> –î–∞—Ç–∞ –ø—Ä–∏–∑–Ω–∞–Ω–Ω—ã—Ö –ø—Ä–µ—Ç–µ–Ω–∑–∏–π</li>
                        </ul>
                        <p class="small text-muted mb-0 mt-2">
                            <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –†–µ–∫–ª–∞–º–∞—Ü–∏–∏ –±–µ–∑ –¥–∞—Ç—ã –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–µ—Ä–∏—è—Ö "–†–µ–∫–ª–∞–º–∞—Ü–∏–∏" –∏ "–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏".
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
<div class="row mt-3 mb-4">
    <div class="col-12">
        <div class="d-flex gap-2">
            <a href="{% url 'claims:time_analysis' %}" class="btn btn-primary">
                üîÑ –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
            </a>
            <button class="btn btn-secondary" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                ‚¨ÜÔ∏è –í–≤–µ—Ä—Ö
            </button>
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª—ã -->
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="year" value="{{ time_analysis_data.year }}">
                {% for consumer in time_analysis_data.consumers %}
                <input type="hidden" name="consumers" value="{{ consumer }}">
                {% endfor %}
                <button type="submit" class="btn btn-outline-primary" name="action" value="save_files">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫
                </button>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('timeAnalysisChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º labels –≤–º–µ—Å—Ç–æ labels_formatted (—Ñ–æ—Ä–º–∞—Ç "2020-12")
            labels: {{ time_analysis_data.monthly_data.labels|safe }},
            datasets: [
                {
                    label: '–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–æ',
                    data: {{ time_analysis_data.monthly_data.manufacture|safe }},
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderColor: 'rgb(76, 175, 80)',
                    borderWidth: 1,
                    // –ü–æ–¥–ø–∏—Å–∏ –ù–ê–î —Å—Ç–æ–ª–±—Ü–∞–º–∏, —Å–∫—Ä—ã–≤–∞–µ–º –Ω—É–ª–∏
                    datalabels: {
                        anchor: 'end',      // –ö–æ–Ω–µ—Ü —Å—Ç–æ–ª–±—Ü–∞
                        align: 'top',       // –ù–∞–¥ —Å—Ç–æ–ª–±—Ü–æ–º
                        color: 'rgb(56, 142, 60)',  // –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        formatter: function(value) {
                            if (value === 0) return '';  // –°–∫—Ä—ã–≤–∞–µ–º –Ω—É–ª–∏
                            return value;
                        }
                    }
                },
                {
                    label: '–†–µ–∫–ª–∞–º–∞—Ü–∏–∏',
                    data: {{ time_analysis_data.monthly_data.reclamations|safe }},
                    backgroundColor: 'rgba(255, 152, 0, 0.7)',
                    borderColor: 'rgb(255, 152, 0)',
                    borderWidth: 1,
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: 'rgb(230, 81, 0)',  // –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        formatter: function(value) {
                            if (value === 0) return '';
                            return value;
                        }
                    }
                },
                {
                    label: '–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏',
                    data: {{ time_analysis_data.monthly_data.claims|safe }},
                    backgroundColor: 'rgba(244, 67, 54, 0.7)',
                    borderColor: 'rgb(244, 67, 54)',
                    borderWidth: 1,
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: 'rgb(198, 40, 40)',  // –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        formatter: function(value) {
                            if (value === 0) return '';
                            return value;
                        }
                    }
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' }
                    }
                },
                title: {
                    display: true,
                    text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–¥–µ–ª–∏–π, —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π –∏ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' —à—Ç.';
                        }
                    }
                },
                // –í–∫–ª—é—á–∞–µ–º –ø–ª–∞–≥–∏–Ω datalabels
                datalabels: {
                    display: true
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '–ü–µ—Ä–∏–æ–¥ (–≥–æ–¥-–º–µ—Å—è—Ü)',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 90,  // –ü–æ–≤–æ—Ä–æ—Ç –Ω–∞ 90¬∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
                        minRotation: 90
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç.)',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        }
                    }
                }
            }
        }
    });
});
</script>