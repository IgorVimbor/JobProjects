<!-- claims/templates/claims/blocks/time_analysis_results.html -->
<!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ ‚Üí —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è ‚Üí –ø—Ä–µ—Ç–µ–Ω–∑–∏—è -->

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-success">
            <strong>
                {% if time_analysis_data.all_consumers_mode %}
                    ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –ø–æ –≤—Å–µ–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º –∑–∞ {{ time_analysis_data.year }} –≥–æ–¥
                {% elif time_analysis_data.consumers|length == 1 %}
                    ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –ø–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—é "{{ time_analysis_data.consumers.0 }}" –∑–∞ {{ time_analysis_data.year }} –≥–æ–¥
                {% else %}
                    ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –ø–æ {{ time_analysis_data.consumers|length }} –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º –∑–∞ {{ time_analysis_data.year }} –≥–æ–¥
                {% endif %}
            </strong>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="alert alert-light">
                    <h6 class="mb-2">‚ÑπÔ∏è –ü–æ—è—Å–Ω–µ–Ω–∏–µ –∫ –≥—Ä–∞—Ñ–∏–∫—É:</h6>
                    <ul class="small mb-0">
                        <li><strong style="color: #FF9800;">‚ñ† –†–µ–∫–ª–∞–º–∞—Ü–∏–∏:</strong> –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∞–∫—Ç–∞—Ö</li>
                        <li><strong style="color: #4CAF50;">‚ñ† –ü—Ä–µ—Ç–µ–Ω–∑–∏–∏:</strong> –°—É–º–º–∞ –ø—Ä–∏–∑–Ω–∞–Ω–Ω—ã—Ö –ø—Ä–µ—Ç–µ–Ω–∑–∏–π –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º —Ä–µ–∫–ª–∞–º–∞—Ü–∏–æ–Ω–Ω—ã–º –∞–∫—Ç–∞–º</li>
                    </ul>
                    <p class="small text-muted mb-0 mt-2">
                        <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∞–≥ (—Å–º–µ—â–µ–Ω–∏–µ) –º–µ–∂–¥—É –¥–∞—Ç–æ–π –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–∏ –∏ –¥–∞—Ç–æ–π –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏ –Ω–∞ —ç—Ç—É —Ä–µ–∫–ª–∞–º–∞—Ü–∏—é.
                    </p>
                </div>
            </div>
            <div class="card-body">
                <!-- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –≥—Ä–∞—Ñ–∏–∫–∞ (160) -->
                <canvas id="timeAnalysisChart" height="160"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
<div class="row mt-3 mb-4">
    <div class="col-12">
        <div class="d-flex gap-2">
            <a href="{% url 'claims:time_analysis' %}" class="btn btn-primary">
                üîÑ –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
            </a>
            <button class="btn btn-secondary" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                ‚¨ÜÔ∏è –í–≤–µ—Ä—Ö
            </button>
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª—ã -->
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="year" value="{{ time_analysis_data.year }}">
                {% for consumer in time_analysis_data.consumers %}
                <input type="hidden" name="consumers" value="{{ consumer }}">
                {% endfor %}
                <button type="submit" class="btn btn-outline-primary" name="action" value="save_files">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫
                </button>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('timeAnalysisChart').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º labels –≤–º–µ—Å—Ç–æ labels_formatted (—Ñ–æ—Ä–º–∞—Ç "2020-12")
            labels: {{ time_analysis_data.monthly_data.labels|safe }},
            datasets: [
                {
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π',
                    data: {{ time_analysis_data.monthly_data.reclamations|safe }},
                    borderColor: 'rgb(255, 193, 7)',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y',  // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π –∫ –æ—Å–∏ Y (—Å–ª–µ–≤–∞)
                    // –ü–æ–¥–ø–∏—Å–∏ –ù–ê–î —Å—Ç–æ–ª–±—Ü–∞–º–∏, —Å–∫—Ä—ã–≤–∞–µ–º –Ω—É–ª–∏
                    datalabels: {
                        anchor: 'end',  // –ö–æ–Ω–µ—Ü —Å—Ç–æ–ª–±—Ü–∞
                        align: 'top',   // –ù–∞–¥ —Å—Ç–æ–ª–±—Ü–æ–º
                        color: 'rgb(204, 102, 0)',  // –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
                        font: {
                            weight: 'normal',
                            size: 12
                        },
                        formatter: function(value) {
                            if (value === 0) return '';  // –°–∫—Ä—ã–≤–∞–µ–º –Ω—É–ª–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ > 0)
                            return value;
                        }
                    }
                },
                {
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π',
                    data: {{ time_analysis_data.monthly_data.claims_counts|safe }},
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    borderColor: 'rgb(244, 67, 54)',
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y',  // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π –∫ –æ—Å–∏ Y (—Å–ª–µ–≤–∞)
                    // –ü–æ–¥–ø–∏—Å–∏ –ù–ê–î —Å—Ç–æ–ª–±—Ü–∞–º–∏, —Å–∫—Ä—ã–≤–∞–µ–º –Ω—É–ª–∏
                    datalabels: {
                        anchor: 'end',  // –ö–æ–Ω–µ—Ü —Å—Ç–æ–ª–±—Ü–∞
                        align: 'top',   // –ù–∞–¥ —Å—Ç–æ–ª–±—Ü–æ–º
                        color: 'rgb(198, 40, 40)',  // –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
                        font: {
                            weight: 'normal',
                            size: 12
                        },
                        formatter: function(value) {
                            if (value === 0) return '';  // –°–∫—Ä—ã–≤–∞–µ–º –Ω—É–ª–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ > 0)
                            return value;
                        }
                    }
                },
                {
                    label: '–°—É–º–º–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π (BYN)',
                    data: {{ time_analysis_data.monthly_data.claims_costs|safe }},
                    borderColor: 'rgb(25, 135, 84)',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y1',  // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏ –∫ –æ—Å–∏ Y1 (—Å–ø—Ä–∞–≤–∞)
                    datalabels: {
                        anchor: 'end',
                        align: 'top',  // 'bottom'
                        color: 'rgb(25, 135, 84)',
                        font: {
                            weight: 'normal',
                            size: 12
                        },
                        formatter: function(value) {
                            if (value === 0) return '';  // –°–∫—Ä—ã–≤–∞–µ–º –Ω—É–ª–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ > 0)
                            return value.toFixed(2);  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ (2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π);
                        }
                    }
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' }
                    }
                },
                title: {
                    display: true,
                    text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π –∏ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π + —Å—É–º–º—ã –ø—Ä–µ—Ç–µ–Ω–∑–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' —à—Ç.';
                        }
                    }
                },
                // –í–∫–ª—é—á–∞–µ–º –ø–ª–∞–≥–∏–Ω datalabels
                datalabels: {
                    display: true
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '–ü–µ—Ä–∏–æ–¥ (–≥–æ–¥-–º–µ—Å—è—Ü)',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 90,  // –ü–æ–≤–æ—Ä–æ—Ç –Ω–∞ 90¬∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
                        minRotation: 90
                    }
                },
                y: {  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Å—å Y –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π –∏ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç.)',
                        font: { size: 12, weight: 'bold' },
                        color: 'rgb(204, 102, 0)'
                    },
                    ticks: {
                        stepSize: 1,
                        color: 'rgb(204, 102, 0)',
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        }
                    }
                },
                y1: {  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Å—å Y1 –¥–ª—è —Å—É–º–º—ã –ø—Ä–µ—Ç–µ–Ω–∑–∏–π
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–°—É–º–º–∞ (BYN)',
                        font: { size: 12, weight: 'bold' },
                        color: 'rgb(25, 135, 84)'
                    },
                    ticks: {
                        color: 'rgb(25, 135, 84)',
                        callback: function(value) {
                            return value.toLocaleString('ru-RU') + ' —Ä—É–±.';
                        }
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            }
        }
    });
});
</script>