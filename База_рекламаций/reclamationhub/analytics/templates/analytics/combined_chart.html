{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'analytics:analytic' %}">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a></li>
                    <li class="breadcrumb-item active">{{ page_title }}</li>
                </ol>
            </nav>

            <h3 class="text-muted">{{ description }}</h3>
        </div>
    </div>

    <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç—á–µ—Ç–∞ -->
    {% if not download_info %}
    <div class="row mb-4">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h5>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞</h5>
                </div>
                <div class="card-body">
                    <p>–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π –ø–æ –¥–∞—Ç–∞–º —Å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –¥–∏–∞–≥—Ä–∞–º–º</p>

                    <form method="post" id="chartForm">
                        {% csrf_token %}

                        <!-- –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ –≥–æ–¥–∞ -->
                        <div class="mb-3">
                            <label for="year" class="form-label fw-bold">–ì–æ–¥ –∞–Ω–∞–ª–∏–∑–∞:</label>
                            <select class="form-select" id="year" name="year" required>
                                <option value="all">–í—Å–µ –≥–æ–¥—ã</option>
                                {% for year in available_years %}
                                    {% if year != "all" %}
                                    <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏:</label>
                            <div class="row">
                                {% for consumer in available_consumers %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                            type="checkbox"
                                            name="consumers"
                                            value="{{ consumer.value }}"
                                            id="consumer{{ forloop.counter }}">
                                        <label class="form-check-label" for="consumer{{ forloop.counter }}">
                                            {{ consumer.name }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <small class="form-text text-muted">
                                ‚úÖ –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã—Ö –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ—Ö –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π
                            </small>
                        </div>

                        <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –∏–∑–¥–µ–ª–∏–π (–û–î–ù–û –∏–∑–¥–µ–ª–∏–µ - radio buttons) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">–í–∏–¥ –∏–∑–¥–µ–ª–∏—è:</label>
                            <div class="row">
                                {% for product in available_products %}
                                <div class="col-md-3 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                            type="radio"
                                            name="product"
                                            value="{{ product.value }}"
                                            id="product{{ forloop.counter }}"
                                            required>
                                        <label class="form-check-label" for="product{{ forloop.counter }}">
                                            {{ product.name }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <small class="form-text text-muted">
                                ‚úÖ –í—ã–±–µ—Ä–∏—Ç–µ <strong>–æ–¥–Ω–æ</strong> –∏–∑–¥–µ–ª–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                            </small>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞:</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="submit" name="chart_type" value="product" class="btn btn-outline-primary">
                                    –ü–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—é –∏–∑–¥–µ–ª–∏—è
                                </button>
                                <button type="submit" name="chart_type" value="manufacture" class="btn btn-outline-primary">
                                    –ü–æ –¥–∞—Ç–µ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
                                </button>
                                <button type="submit" name="chart_type" value="message" class="btn btn-outline-primary">
                                    –ü–æ –¥–∞—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                                </button>
                                <button type="submit" name="chart_type" value="combined" class="btn btn-outline-primary">
                                    –°–≤–æ–¥–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
                                </button>
                                <button type="submit" name="chart_type" value="all" class="btn btn-primary">
                                    –í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å—Ä–∞–∑—É
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    {% if messages %}
    <div class="row">
        <div class="col-12">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ -->
    {% if download_info %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-body">
                    <p><strong>{{ download_info.message }}</strong></p>
                    <p class="text-muted">
                        –§–∏–ª—å—Ç—Ä: {{ download_info.filter_text }} |
                        –ì–æ–¥: {% if download_info.year == "all" %}–í—Å–µ –≥–æ–¥—ã{% else %}{{ download_info.year }}{% endif %} |
                        –í—Å–µ–≥–æ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π: {{ download_info.total_records }}
                    </p>

                    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
                    {% if download_info.charts %}

                        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –∏–∑–¥–µ–ª–∏—é -->
                        {% if download_info.charts.product %}
                        <div class="mt-4 border-top pt-4">
                            <h5>üìä {{ download_info.charts.product.title }}</h5>
                            <img src="data:image/png;base64,{{ download_info.charts.product.base64 }}"
                                 class="img-fluid"
                                 alt="–ì—Ä–∞—Ñ–∏–∫ –ø–æ –∏–∑–¥–µ–ª–∏—é">
                            <div class="mt-2">
                                <small class="text-muted">
                                    üíæ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω: <code>{{ download_info.charts.product.png_path }}</code>
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–∞—Ç–µ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è -->
                        {% if download_info.charts.manufacture %}
                        <div class="mt-4 border-top pt-4">
                            <h5>üìÖ {{ download_info.charts.manufacture.title }}</h5>
                            <img src="data:image/png;base64,{{ download_info.charts.manufacture.base64 }}"
                                 class="img-fluid"
                                 alt="–ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–∞—Ç–µ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è">
                            <div class="mt-2">
                                <small class="text-muted">
                                    üíæ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω: <code>{{ download_info.charts.manufacture.png_path }}</code>
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–∞—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        {% if download_info.charts.message %}
                        <div class="mt-4 border-top pt-4">
                            <h5>üì¨ {{ download_info.charts.message.title }}</h5>
                            <img src="data:image/png;base64,{{ download_info.charts.message.base64 }}"
                                 class="img-fluid"
                                 alt="–ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–∞—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è">
                            <div class="mt-2">
                                <small class="text-muted">
                                    üíæ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω: <code>{{ download_info.charts.message.png_path }}</code>
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        <!-- –°–æ–≤–º–µ—â–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ -->
                        {% if download_info.charts.combined %}
                        <div class="mt-4 border-top pt-4">
                            <h5>üìà {{ download_info.charts.combined.title }}</h5>
                            <img src="data:image/png;base64,{{ download_info.charts.combined.base64 }}"
                                 class="img-fluid"
                                 alt="–°–æ–≤–º–µ—â–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫">
                            <div class="mt-2">
                                <small class="text-muted">
                                    üíæ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω: <code>{{ download_info.charts.combined.png_path }}</code>
                                </small>
                            </div>
                        </div>
                        {% endif %}

                    {% endif %}

                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div class="d-flex gap-2 mt-4 pt-3 border-top">
                        <a href="{% url 'analytics:combined_chart' %}" class="btn btn-primary">
                            üîÑ –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
                        </a>
                        <button class="btn btn-secondary" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                            ‚¨ÜÔ∏è –í–≤–µ—Ä—Ö
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}